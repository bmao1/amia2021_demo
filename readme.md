# AMIA Nov 2021 - NLP demo

1. Input data prep
	- Clone synthea repo, and follow the quick start guide
		```bash
		git clone https://github.com/synthetichealth/synthea.git
		mv synthea.diff synthea/
		cd synthea
		git checkout a3482c856d30410e438047845796095a827cca41
		./gradlew build check test
		```
	- Apply the patch to update the settings in `./synthea/src/main/resources/synthea.properties` to allow for creating bulk data and clinical notes 
		```bash
		git apply synthea.diff
		```
		
	- run synthea to create patient data
		`./run_synthea -p 10` or `./run_synthea -p 10 -m covid19` (for covid-19-related fake data)

2. Prepare cTAKES server
	- option 1, use demo server {IP}. The server is available between {date1} and {date2} for AMIA demo use only
	- option 2, install you own server in localhost (require ~4G memory and ~12G storage). 
		Register at UMLS (https://www.nlm.nih.gov/research/umls/index.html). Obtain API key after registration.
		```bash
		cd <amia demo directory>
		git clone https://github.com/Machine-Learning-for-Medical-Language/ctakes-covid-container   # Private repo ?
		cd ctakes-covid-container
		docker build -t ctakes-covid .
		export umls_api_key={UMLS-api-key}
		./start_rest.sh
		```
		Confirm the server is running by check localhost:8080 for Tomcat.
		check container logs if localhost:8080 is not accessible:
			i. "umls user valided" message should appear in the logs
			ii. the container takes a while to start, the last message should be similar to "org.apache.catalina.startup.Catalina.start Server startup in [16,375] milliseconds"


3. NLP process
	This process read in clinical notes from ./synthea/output/notes/\*.txt files, send to cTAKES server. The result is converted in to FHIR R4 resources.
	Current version support medical terms in 4 categories, with one-to-one FHIR resource mapping 
  		DiseaseDisorderMention => Condition
  		SignSymptomMention => Observation
  		MedicationMention => MedicationStatement
  		ProcedureMention => Procedure
  	```bash
	cd <amia demo directory>
  	git clone https://github.com/bmao1/NLP_to_FHIR
  	cd NLP_to_FHIR
	mkdir -p output/fhir
  	python extract_cuis_edits.py ../synthea/output/notes/ output/fhir
  	```

4. Loading processed structured data into analytics database (postgres)
	- Start postgres container. DB data will be stored in ./data subdirectory; Input data should be placed in ./input subdirectory (Edit volumne mapping as needed)
```bash
cd <amia demo directory>
docker run -d\
    -p 5432:5432 \
    --name postgres13 \
    -e POSTGRES_USER=postgres \
    -e POSTGRES_PASSWORD=example \
    -e POSTGRES_DB=amia \
    -e POSTGRES_HOST=postgres \
    -e PGDATA=/var/lib/postgresql/data/pgdata \
    -v `pwd`/data:/var/lib/postgresql/data \
    -v `pwd`/input:/var/lib/postgresql/input \
    postgres:13
```

	- Using the following command to load data. For demo purpose, all FHIR resources are loaded into one table
		Known issue
			1. Text generated by synthea contains `\"`, which cause when loading into postgres
				Solution: remove `\"` with `sed 's/\\"//' filename`. (macOS may use `sed -i '' 's/\\"//' filename`)
			2. Python default output for json use single quote `'`, postgres `\copy` takes double quote `"`
				Solution: write ndjson file with `f.write(json.dumps(json_output))` or replace `'` with `"` manually
		Option 1, load data using postgres cli 
		```
		# Start interactive CLI 
		docker exec -it postgres13 psql -U postgres amia
		# Create table 
		CREATE TABLE IF NOT EXISTS demo (contents jsonb);
		
		# Load ndjson file 
		\copy demo from '/var/lib/postgresql/input/Patient.ndjson'
		\copy demo from '/var/lib/postgresql/input/Observation.ndjson'
		```
		Option 2, run python demo_load.py, using default ./input location, psycopg2 is required `pip install psycopg2`
			***Code in testing, not finalized yet***
		`python demo_load.py`
 	

5. Sample query to get patient gender, dob, race, ethnicity. Query can run via CLI or API
```sql
select id
	, gender
	, birthDate
	, max(race)
	, max(ethnicity)
	from (
		select contents -> 'id' as id
			, contents -> 'gender' as gender
			, (contents ->> 'birthDate')::timestamptz as birthDate
			, case when (extext -> 'valueCoding' ->> 'code') in ('1002-5','2028-9','2054-5','2076-8','2106-3') then (extext -> 'valueCoding' ->> 'display') else '' end as race
			, case when (extext -> 'valueCoding' ->> 'code') in ('2135-2','2186-5') then (extext -> 'valueCoding' ->> 'display') else '' end as ethnicity
		from demo, jsonb_array_elements(contents -> 'extension') ext, jsonb_array_elements(ext -> 'extension') extext
		where contents->> 'resourceType' = 'Patient' 
			and extext ->> 'url' = 'ombCategory'
	) as pt
	group by id
		, gender
		, birthDate
;

	
```

sample query to get observation code
```sql
SELECT contents -> 'subject' -> 'reference' as id 
	, coding_arr -> 'code' as code
	, (modextext ->> 'valueDate')::timestamptz end as notes_date
FROM demo
	, jsonb_array_elements(contents -> 'code' -> 'coding')  coding_arr
	, jsonb_array_elements(contents -> 'modifierExtension')  modext
	, jsonb_array_elements(modext -> 'extension') modextext
where contents->> 'resourceType' = 'Observation' 
	and coding_arr ->> 'system' = 'http://snomed.info/sct'
	and modextext ->> 'url' ='dateofauthorship'
	-- and coding_arr ->> 'system' = 'custom' 
	-- and coding_arr ->> 'code' = '33962009'
limit 10;
```
UMLS use cui code "a0_72" for covid-19






